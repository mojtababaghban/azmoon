\RequirePackage{dashrule}
\RequirePackage{qrcode}

\setlength\leftmg{.5cm}
\setlength\rightmg{.5cm}
\setlength\he@dsep{1.5pt}

\newlength{\rightpad}
\newlength{\leftpad}
\newlength{\toppad}
\newlength{\bottompad}
\newlength{\rulewidth}
\newlength{\numcolwidth}
\newlength{\pointcolwidth}
\setlength\rightpad{2pt plus 1pt minus 1pt}
\setlength\leftpad{2pt plus 1pt minus 1pt}
\setlength\toppad{2pt plus 1pt minus 1pt}
\setlength\bottompad{2pt plus 1pt minus 1pt}
\setlength\rulewidth{.5pt}
\setlength\numcolwidth{.5cm}
\setlength\pointcolwidth{.75cm}

\newcommand{\question@tabling}[3]{%
	\newbox\quesbox%
	\setbox\quesbox=\vbox{%
		\hsize=\dimexpr \linewidth-\numcolwidth-\pointcolwidth
		-4\rulewidth-\rightpad-\leftpad\relax%
		\setlength\linewidth{\hsize}%
		\vskip\toppad#2\vskip\bottompad%
	}%
	\newbox\numbox%
	\setbox\numbox=\vbox to \ht\quesbox{%
		\hsize=\numcolwidth%
		\vskip\toppad\hfil#1\hfil\vskip\bottompad\vfil%
	}%
	\newbox\pointbox%
	\setbox\pointbox=\vbox to \ht\quesbox{%
		\hsize=\pointcolwidth%
		\vskip\toppad\hfil$#3$\hfil\vskip\bottompad\vfil%
	}%
	\newdimen\freespace%
	\freespace=\dimexpr\pagegoal-\pagetotal-\pageshrink\relax%
	\ifdim\dimexpr\ht\quesbox+\dp\quesbox+\rulewidth\relax<\freespace%
		\newbox\rowbox%
		\setbox\rowbox=\hbox{%
			\vrule width\rulewidth%
			\box\pointbox%
			\vrule width\rulewidth%
			\hskip\leftpad\box\quesbox\hskip\rightpad%
			\vrule width\rulewidth%
			\box\numbox%
			\vrule width\rulewidth%
		}%
		\newbox\totalquesbox%
		\setbox\totalquesbox=\vbox{%
			\kern-\rulewidth%
			\hrule width\linewidth height\rulewidth%
			\box\rowbox%
			\hrule width\linewidth height\rulewidth%
		}%
		\box\totalquesbox\nointerlineskip%
	\else%
		\newdimen\splitpos%
		\splitpos=\dimexpr\freespace-\rulewidth\relax%
		\newbox\quesbottombox%
		\newbox\questopbox%
		\newbox\cquesbox%
		\loop%
			\typeout{splitpos is \the\splitpos \the\dimexpr\ht\questopbox+\dp\questopbox+\rulewidth\relax \the\freespace}%
			\setbox\cquesbox\copy\quesbox%
			\setbox\questopbox\vsplit\cquesbox to\dimexpr\splitpos\relax%
			\setbox\questopbox\vbox{\unvbox\questopbox}%
			\advance \splitpos -3pt%
			\ifnum\ifdim\dimexpr\ht\questopbox+\dp\questopbox+2\rulewidth\relax<\freespace 1\else\ifdim\splitpos<3pt 1\else0\fi\fi=1\else%
		\repeat%
		\ifdim\dimexpr\ht\questopbox+\dp\questopbox+2\rulewidth\relax>\freespace%
	\eject%
	\typeout{topbox is \the\ht\questopbox and \the\dp\questopbox and quesbox is \the\ht\quesbox and freespace is \the\freespace}%
	\newbox\rowbox%
	\setbox\rowbox=\hbox{%
		\vrule width\rulewidth%
		\box\pointbox%
		\vrule width\rulewidth%
		\hskip\leftpad\box\quesbox\hskip\rightpad%
		\vrule width\rulewidth%
		\box\numbox%
		\vrule width\rulewidth%
	}%
	\newbox\totalquesbox%
	\setbox\totalquesbox=\vbox{%
		\kern-\rulewidth%
		\hrule width\linewidth height\rulewidth%
		\box\rowbox%
		\hrule width\linewidth height\rulewidth%
	}%
	\box\totalquesbox\nointerlineskip%
	\else%
	\typeout{questopbox height is \the\ht\questopbox and \the\dp\questopbox}%
	\setbox\quesbottombox=\box\cquesbox
	\newbox\numtopbox%
	\setbox\numtopbox=\vbox to \ht\questopbox{%
		\hsize=\numcolwidth\vskip\toppad\hfil #1\hfil\vskip\bottompad\vfil%
	}%
	\newbox\numbottombox%
	\setbox\numbottombox=\vbox to \ht\quesbottombox{%
		\hsize=\numcolwidth\hfil \hfil\vfil%
	}%
	\newbox\pointtopbox%
	\setbox\pointtopbox=\vbox to \ht\questopbox{%
		\hsize=\pointcolwidth\vskip\toppad\hfil $#3$\hfil\vskip\bottompad\vfil%
	}%
	\newbox\pointbottombox%
	\setbox\pointbottombox=\vbox to \ht\quesbottombox{%
		\hsize=\pointcolwidth\hfil \hfil\vfil%
	}%
	\newbox\rowtopbox%
	\setbox\rowtopbox=\hbox{%
		\vrule width\rulewidth%
		\box\pointtopbox%
		\vrule width\rulewidth%
		\hskip\leftpad\box\questopbox\hskip\rightpad%
		\vrule width\rulewidth%
		\box\numtopbox%
		\vrule width\rulewidth%
	}%
	\newbox\totalquestopbox%
	\setbox\totalquestopbox\vbox{%
		\kern-\rulewidth%
		\hrule width\linewidth height\rulewidth%
		\box\rowtopbox%
		\nointerlineskip\hdashrule{\linewidth}{\rulewidth}{2pt}%
	}%
	\box\totalquestopbox\nointerlineskip%
	\eject%
	\newbox\rowbottombox%
	\setbox\rowbottombox=\hbox{%
		\vrule width\rulewidth%
		\box\pointbottombox%
		\vrule width\rulewidth%
		\hskip\leftpad\box\quesbottombox\hskip\rightpad%
		\vrule width\rulewidth%
		\box\numbottombox%
		\vrule width\rulewidth%
	}%
	\newbox\totalquesbottombox%
	\setbox\totalquesbottombox\vbox{%
		\vbox{\hdashrule{\linewidth}{\rulewidth}{2pt}}\nointerlineskip%
		\box\rowbottombox%
		\hrule width\linewidth height\rulewidth%
	}%
	\box\totalquesbottombox\nointerlineskip%
	\fi%
	\fi%
}
\newcommand{\section@tabling}[1]{%
	\newbox\sectionbox%
	\setbox\sectionbox=\vbox{%
		\hsize=\dimexpr\linewidth-2\rulewidth\relax%
		\vskip 2pt plus 1pt minus 1pt%
		\hfil\textbf{#1}\hfil%
		\vskip 2pt plus 1pt minus 1pt%
	}%
	\newbox\rowbox%
	\setbox\rowbox=\vbox{%
		\kern-\rulewidth%
		\hrule width\linewidth height\rulewidth%
		\vrule width\rulewidth\box\sectionbox\vrule width\rulewidth%
		\hrule width\linewidth height\rulewidth%
	}
	\box\rowbox\nointerlineskip%
}
\def\fheader@tabling{%
	\large%
	\newdimen\headcolsep%
	\headcolsep=2pt%
	\newdimen\widthfree%
	\widthfree=\dimexpr \linewidth-2\rulewidth-\leftpad-\rightpad-1cm-2\headcolsep\relax%
	\newbox\rheadbox%
	\newbox\cheadbox%
	\newbox\lheadbox%
	\newbox\qrbox%
	\newbox\rowbox%
	\newbox\headbox%
	\newbox\qrhbox%
	\newbox\qrvbox%
	\newbox\qrrowvbox%
	\newbox\qrheadbox%
	\setbox\rheadbox=\vbox{%
		\hsize=.35\widthfree%
		\vskip\toppad%
		‎\textbf{نام و نام‌خانوادگی: \student@name}
		\par
		‎\textbf{پایه \@grade\ شعبه \@branch}
		\par
		\textbf{\school@title\ \@school}%
		\vskip\bottompad%
	}%
	\setbox\lheadbox=\vbox{%
		\vskip\toppad%
		\hsize=.35\widthfree%
		\hfill\textbf{تاریخ ارزشیابی: \exam@date}
		\par
		\hfill‎\textbf{زمان پاسخگویی: \answer@time}
		\par
		\hfill\textbf{\total{numques} سوال در \pageref{LastPage} صفحه}%
		\vskip\bottompad%
	}%
	\setbox\cheadbox=\vbox{%
		\hsize=.3\widthfree%
		\centering
		\includegraphics[width=3.5cm, height=1.2cm]{logo.jpeg}
	}%
		\setbox\qrbox=\vbox to \ht\rheadbox{%
		\hsize=.5cm%
		\vskip\toppad%
		\qrcode[height=.5cm]{786521}%
		\vfil%
		\qrcode[height=.5cm]{786521}%
		\vskip\bottompad%
	}%
	\setbox\rowbox=\hbox{%
		\hskip\rightpad%
		\copy\qrbox%
		\hskip\headcolsep%
		\box\rheadbox%
		\box\cheadbox%
		\box\lheadbox%
		\hskip\headcolsep%
		\box\qrbox%
		\hskip\leftpad%
	}
	\setbox\headbox=\vbox{%
		\hrule height\rulewidth%
		\vrule width\rulewidth%
		\box\rowbox%
		\vrule width\rulewidth%
		\hrule height\rulewidth%
	}%
	\setbox\qrhbox=\hbox to \dimexpr\linewidth-2\rulewidth\relax{%
		\hskip\rightpad%
		\qrcode[height=.5cm]{786521}\hfill\qrcode[height=.5cm]{786521}%
		\hskip\leftpad%
	}%
	\setbox\qrvbox=\vbox{%
		\hsize=\dimexpr\linewidth-2\rulewidth\relax%
		\vskip\toppad%
		\box\qrhbox%
		\vskip\bottompad%
	}
	\setbox\qrrowvbox=\hbox to \linewidth{%
		\vrule width\rulewidth%
		\box\qrvbox%
		\vrule width\rulewidth%
	}
	\setbox\qrheadbox=\vbox{%
		\hrule height\rulewidth%
		\box\qrrowvbox%
		\hrule height\rulewidth%
	}
	\box\headbox%
	\nointerlineskip%
	\vskip3pt%
	\vbox{\hdashrule{\linewidth}{\rulewidth}{2pt}}%
	\nointerlineskip%
	\vskip3pt%
	\box\qrheadbox%
	\nointerlineskip%
	\vskip-\baselineskip%
}
\def\mheader@tabling{%
%	\newbox\headbox%
%	\newbox\rowbox%
%	\setbox\rowbox=\hbox to \dimexpr\linewidth-2\rulewidth\relax{%
%		\hskip\rightpad%
%		\textbf{نام و نام‌خانوادگی:}\hfill \textbf{صفحه \thepage\ از \pageref{LastPage}}%
%		\hskip\leftpad%
%	}%
%	\setbox\headbox=\vbox{%
%		\hsize=\dimexpr\linewidth\relax%
%		\hrule height\rulewidth%
%		\vrule width\rulewidth%
%		\box\rowbox%
%		\vrule width\rulewidth%
%		\hrule height\rulewidth%
%	}
%	\box\headbox\nointerlineskip%
%	\vskip-\baselineskip%
	\setlength{\fboxsep}{0pt}
	\setlength{\fboxrule}{.5pt}
	\framebox[\linewidth]{%
%		\vskip\toppad%
		\hskip\leftpad%
		\textbf{نام و نام‌خانوادگی:}\hfill \textbf{صفحه \thepage\ از \pageref{LastPage}}%
		\hskip\rightpad%
%		\vskip\bottompad%
	}
}